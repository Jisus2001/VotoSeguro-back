trigger:
  branches:
    include:
      - main

pool:
  name: Default

variables:
  DOCKER_BUILDKIT: 1
  SONAR_HOST_URL: "http://localhost:9000"
  SONAR_TOKEN: "$(SonarTokenn)"   # lo guardas como secret variable

steps:
  # 1ï¸âƒ£ Checkout del cÃ³digo
  - checkout: self

  # 2ï¸âƒ£ Instalar Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: "18.x"
    displayName: "Install Node.js"

  # 3ï¸âƒ£ Instalar dependencias
  - script: npm ci
    displayName: "Install npm dependencies"

  # 4ï¸âƒ£ Build de las imÃ¡genes de Docker
  - script: docker-compose build
    displayName: "Build Docker images"

  # 5ï¸âƒ£ Levantar contenedores de tests (detached)
  - script: docker-compose up -d
    displayName: "Start test containers"

  # 6ï¸âƒ£ DiagnÃ³stico de memoria dentro del contenedor unit-tests
  - script: docker exec unit-tests free -h
    displayName: "Verificar memoria disponible en unit-tests"

    # 7ï¸âƒ£ Ejecutar Unit Tests (dentro de contenedor)
  - script: |
      echo "ðŸš€ Ejecutando pruebas unitarias en contenedor..."
      docker exec unit-tests sh -c "
        mkdir -p /app/reports/unit &&
        node --expose-gc --experimental-vm-modules --max-old-space-size=2048 \
        node_modules/jest/bin/jest.js tests/Unitarias \
        --runInBand --logHeapUsage --verbose \
        --reporters=default --reporters=jest-junit"
      
      echo "ðŸ“ Copiando reportes de Unit Tests al host..."
      docker cp unit-tests:/app/reports ./reports
    displayName: "Run Unit Tests (with report export)"
    continueOnError: false


  # 8ï¸âƒ£ Detener solo el contenedor de Unit Tests
  - script: |
      echo "ðŸ§¹ Deteniendo contenedor de Unit Tests..."
      docker stop unit-tests || true
      docker rm unit-tests || true
    displayName: "Stop only Unit Test container"


  # 9ï¸âƒ£ Ejecutar Integration Tests directo en el agente
  - script: |
      echo "ðŸš€ Ejecutando pruebas de integraciÃ³n..."
      mkdir -p ./reports/integration
      node --expose-gc --experimental-vm-modules --max-old-space-size=3072 \
        node_modules/jest/bin/jest.js tests/Integracion \
        --runInBand --logHeapUsage --verbose \
        --reporters=default --reporters=jest-junit
      echo "ðŸ“ Reportes generados en ./reports/integration:"
      dir ./reports/integration
    displayName: "Run Integration Tests"
    continueOnError: false
    env:
      JEST_JUNIT_OUTPUT_DIR: ./reports/integration
      JEST_JUNIT_OUTPUT_NAME: integration-report.xml

  # ðŸ”Ÿ Publicar resultados Unit & Integration
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "**/reports/**/*.xml"
      testRunTitle: "All Tests"
      mergeTestResults: true
    condition: always()

  # âœ… âœ… âœ… 1ï¸âƒ£1ï¸âƒ£ Instalar Sonar Scanner CLI
  - script: npm install -g sonar-scanner
    displayName: "Install SonarQube Scanner CLI"

  # âœ… âœ… âœ… 1ï¸âƒ£2ï¸âƒ£ Ejecutar SonarQube Analysis
  - script: >
      sonar-scanner
      -Dsonar.projectKey=votoseguro-back
      -Dsonar.sources=.
      -Dsonar.host.url=$(SONAR_HOST_URL)
      -Dsonar.login=$(SONAR_TOKEN)
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
    displayName: "Run SonarQube Analysis"
